from datetime import datetime
from django.core.management.base import BaseCommand
from brand.models import *
from datasource.models import *
from django.utils import timezone
import re
class Command(BaseCommand):
    help = 'This script enters information from usnic into brands for FCU entity type'

    def _generate_tag(self, bt_tag, increment=0, existing_tags=None):
            og_tag = bt_tag

            # memoize existing tags for faster recursion
            if not existing_tags:
                existing_tags = {x.tag for x in self.objects.all()}
            if increment < 1:
                bt_tag = og_tag
            else:
                bt_tag = og_tag + "_" + str(increment).zfill(2)

            if bt_tag not in existing_tags:
                return bt_tag
            else:
                return self._generate_tag(og_tag, increment=increment + 1, existing_tags=existing_tags)
            
    def handle(self, *args, **kwargs):
        print("Running db_changes_fcu.py")
        field_names = ["ncua", "website", "country", "legal_name", "rssd", "lei", "fdic_cert", "ein", "occ", "thrift_hc", "cusip"]
        filtered_usnic = Usnic.objects.filter(entity_type = "FCU").values("ncua", "website", "country", "legal_name", "rssd", "lei", "fdic_cert", "ein", "occ", "thrift_hc", "cusip" )
        #selects the two fields to check for duplicates
        brand_tags = Brand.objects.values("tag", "name")
        existing_tags = []
        existing_names = []
        mapped_rows = []
        for row in brand_tags:
            existing_tags.append(row["tag"])
            existing_names.append(row["name"])
        for row in filtered_usnic:
            if row["legal_name"] in existing_names:
                continue
            new_name = row["legal_name"]+"_CFU"
            #rssd numbers in the list I got
            rssdIds = [725291, 3945737, 166595, 767385, 772183, 774598, 465878, 469081, 685872, 529985, 447294, 212492, 1000173, 865384, 672984, 3618545, 1085349, 83834, 3623110, 548276,
                261940, 5164439, 995384, 261294, 558891, 259693, 778680, 219389, 741590, 555591, 2785477, 2785459, 702694, 139898, 688190, 23894, 499480, 602785, 4953337, 2744326,
                3229503, 1097306, 31835, 2877831, 124830, 99442, 476539, 642437, 68831, 835743, 780049, 476445, 706236, 586335, 687054, 364430, 910239, 382537, 800442, 860334, 502652,
                1247455, 914648, 919344, 121642,2937182, 188739, 2340867, 2329200, 280688, 3842630, 3608751, 165691, 652089, 1135842, 2590, 805492, 675882, 3326176, 916745, 684455,
                573698, 317388, 1097463, 454283, 562290, 24994, 2979212, 1132382, 609195, 176473, 925354, 1108985, 1357046, 498625, 826590, 234597, 2087939, 674081, 605580, 678678,
                2757111, 821979, 667195, 203986, 1491641, 576783, 839189, 541857, 1848825, 343088, 268677, 3190023, 370833, 785099, 256991, 1109722, 420578, 2605249, 318684, 531250,
                1063084, 751852, 1109571, 833598, 283876, 1095469, 904359, 386384, 3368916, 298393, 3045721, 64552, 537887, 900070, 3439179, 514132, 3174920, 729945, 1246681, 3186576,
                69333, 732253, 55635, 680130, 807076, 2697963, 1099252, 761075, 930853, 655884, 1913684, 749073, 1085460, 398583, 127587, 646387, 596277, 656685, 2770660, 2746245, 
                3135435, 2581718, 23643, 467658, 522034, 2756730, 1086739, 1099382, 239480, 578237, 512875, 1977154, 1080595, 361279, 460033, 2483438, 421089, 299868, 394099, 248295,
                64897, 530598, 2613141, 1016099, 4455176, 358091, 501280, 819556, 2557414, 126049, 847492, 108278, 523871, 127288, 4253699, 4254539, 4254838, 4985637, 4253916, 4985833,
                3873353, 4537317, 3878732, 4537308, 3873296, 3878741, 4253475, 4254557, 4253532, 3944721, 3873250, 3944758, 4254463, 4254511, 4254548, 3872927, 4254584, 3878769, 639893,
                3873344, 3944730, 3950759, 4985468, 4253608, 3944776, 4254436, 4985495, 3873410, 4985860, 4184850, 3872918, 4253420, 4254687, 4985598, 4985619, 4320229, 3878808, 4253934,
                3873269, 4254342, 4254007, 4184841, 4254641, 4254904, 4254931, 3873232, 3873399, 4254726, 3873326, 4253635, 3873380, 3872936, 4253783, 4985682, 3873371, 3878796, 4253831,
                4253840, 4253886, 4253895, 3878817, 3873278, 5047309, 4254016, 4184832, 4254315, 3878778, 4254333, 4253626, 684277, 3319972, 398837, 292887, 117195, 989794, 2228590,
                697035, 861582, 334590, 443193, 755252, 663889, 799386, 466987, 94193, 501794, 793487, 2201883, 66154, 1107090, 975256, 499275, 553083, 427287, 429786, 1098198, 305693,
                678098, 967895, 116778, 2270263, 1363784, 497178, 783880, 697594, 132170, 461991, 793076, 891084, 805689, 293295, 2242653, 299671, 693989, 41580, 1106525, 985451, 550288,
                111894, 1135806, 414371, 407494, 4254874, 205243, 1247615, 33147, 567736, 653134, 1099092, 314444, 826581, 4211336, 879439, 299699, 742681, 970185, 848248, 597087, 
                1013379, 420989, 870481, 4842392, 475792, 2385493, 875936, 979197, 4151012, 522276, 4151003, 334264, 1492956, 759045, 663982, 3394643, 90177, 1014974, 1085518, 3386264,
                222875, 254849, 1491445, 991359, 825454, 2619349, 670430, 11640, 799948, 966731, 714839, 3288425, 1083318, 3386880, 1097070, 78241, 600099, 1107009, 718145, 954671, 
                3228681, 3224302, 1082692, 1140190, 1098705, 114840, 924236, 489548, 843542, 1096448, 1083587, 1141302, 1098880, 1097100, 1139998, 166081, 691583, 908179, 887199, 969639, 
                590640, 568939, 1099690, 100843, 601171, 266682, 90588, 100393, 1109731, 3674215, 1006652, 432058, 596286, 435198, 244037, 3371701, 364690, 859299, 5450178, 659640,
                389086, 1136102, 734350, 250476, 536059, 656694, 3203138, 628981, 1083158, 669199, 101738, 1080568, 413495, 167190, 230973, 48570, 123794, 1086775, 1119431, 193872,
                263092, 929585, 84073, 736194, 84541, 289739, 969255, 1096952, 612784, 307697, 25571, 714389, 533124, 2008130, 8695, 4361923, 710390, 736671, 779182, 628589, 165589,
                1129494, 197094, 2349703, 519977, 2590644, 725741, 1119057, 737191, 3816547, 251978, 2342816, 681687, 131780, 400299, 2339759, 781475, 1100000, 536527, 122591,
                144388, 701370, 329550, 258490, 2006024, 196882, 63984, 349987, 1085303, 549787, 411286, 868778, 715377, 412676, 3097850, 754693, 3260551, 1082236, 958893, 794091,
                4452960, 535034, 360683, 2915845, 406385, 117391, 397755, 831389, 729075, 283438, 1130548, 3235401, 365950, 109592, 815754, 815398, 3626858, 3628535, 903473, 176295,
                669498, 22972, 34434, 1081097, 725787, 708687, 17987, 612793, 371791, 897648, 332224, 628495, 648895, 845470, 513498, 795294, 317397, 2111432, 376237, 3696093, 94139,
                579636, 691042, 931597, 905383, 1019335, 845395, 549992, 345680, 106685, 89292, 519360, 3364600, 3039636, 699990, 3195297, 169381, 621487, 2317690, 201674, 714437, 601283,
                633994, 572794, 304285, 1000977, 967699, 321497, 2943419, 664653, 2333131, 2333140, 2561952, 157481, 525790, 529293, 3605022, 3843392, 125378, 54571, 933498, 1002391,
                13390, 327088, 506191, 148096, 1892, 522593, 848592, 217376, 159896, 574396, 2507491, 4985570, 4197074, 763976, 857772, 973775, 945286, 201094, 867285, 1109900, 70889,
                554099, 85799, 93374, 935308, 822882, 1417931, 2794732, 3334489, 980698, 493497, 1017975, 741385, 750985, 2938769, 3157017, 4389, 149972, 510778, 2343167, 691686, 751085,
                384296, 335346, 761486, 3447428, 632380, 746595, 949471, 442589, 4189314, 70638, 320034, 784159, 1098321, 173342, 880332, 340489, 834773, 294827, 2356514, 972648, 1096484,
                1086355, 89032, 52492, 897170, 5653018, 540896, 2059990, 837297, 3832033, 947495, 956938, 1084575, 700878, 675855, 431592, 506584, 490179, 112592, 3664216, 739896, 
                3340725, 4098564, 503172, 857389, 4176855, 2526755, 473275, 929987, 6897, 40033, 475493, 3437157, 612672, 4422851, 573335, 1082786, 179689, 161086, 430036, 725385,
                278498, 413879, 3835454, 961295, 334880, 3878787, 438797, 162494, 74793, 4414838, 5473421, 118156, 1098509, 280295, 763677, 1253773, 52951, 423092, 109387, 896191,
                3805055, 1134751, 608899, 37079, 4346676, 974697, 844138, 961192, 611684, 635091, 492883, 240486, 3176698, 931289, 2848653, 80589, 2764977, 767732, 135836, 3223921,
                1137033, 1096662, 563934, 852544, 1248939, 114082, 935559, 4297527, 3531176, 378875, 166278, 752596, 1081686, 497990, 584171, 3368925, 5754997, 961790, 1082544, 683775,
                98995, 1015999, 244082, 1131723, 626192, 5210372, 301293, 4373579, 294087, 1133754, 348485, 303381, 25085, 860053, 2376727, 984995, 582074, 662396, 1008692, 962274, 
                1109487, 134455, 720791, 497954, 315580, 12142, 700430, 473930, 2385514, 622037, 703039, 1084016, 741956, 593249, 1097061, 472531, 443773, 879989, 3305434, 274098, 
                2489449, 400084, 562683, 127475, 375780, 212586, 4254258, 134437, 448077, 446185, 616894, 392198, 814672, 874470, 3450754, 22048, 1083895, 994435, 1945247, 281890, 
                90337, 286073, 484897, 544335, 837840, 1100028, 306597, 1139103, 621384, 57992, 785688, 463593, 438395, 3593343, 4194765, 510693, 240084, 373795, 624787, 617882, 511579,
                162980, 229584, 416197, 352183, 6486, 956880, 499994, 213293, 99189, 1086627, 311939, 608198, 856186, 1084829, 511832, 367075, 574088, 56799, 501132, 732637, 1107081, 
                628552, 150491, 940786, 1086056, 671996]
            try:
                rssd = int(row["rssd"])
                #checks if rssd number is in the list and adds _CDFI
                if rssd in rssdIds:
                    new_name = row[3] + "_CDFI"
            except:
                rssd = ""
            #getting the datetime django wants
            naive_datetime = datetime.now()
            aware_datetime = timezone.make_aware(naive_datetime)
            #removes special characters exept letters/numbers and spaces since we want to replace spaces with _
            tag_name = re.sub(r"[^A-Za-z0-9 ]+", "", row["legal_name"].lower())
            #creates the tag
            tag = self._generate_tag(tag_name.lower().replace(" ", "_"), 0, existing_tags)
            #adds tags to existing ones to check there are no duplicates
            existing_tags.append(tag)
            websiteurl = row["website"]
            #checks if there is a website url
            if websiteurl == None:
                #creates the Brand object 
                Brand.objects.create(created = aware_datetime, modified = aware_datetime , name = row["legal_name"], name_locked = 0, aliases = new_name.lower(),
                                countries = row["country"], tag = tag, tag_locked = 1, lei = row["lei"], googleid = "", rssd = row["rssd"], cusip = row["cusip"],  
                                thrift_hc = row["thrift_hc"], ncua = row["ncua"], fdic_cert = row["fdic_cert"], occ = row["occ"], ein = row["ein"])
            #adds "https://" for validation and 
            else:
                if "https://" in websiteurl or "http://" in websiteurl:
                    websiteurl = websiteurl.lower()
                else:
                    websiteurl = "https://" + websiteurl.lower()
                Brand.objects.create(created = aware_datetime, modified = aware_datetime , name = row["legal_name"], name_locked = 0, aliases = new_name.lower(), 
                                     website = websiteurl, countries = row["country"], tag = tag, tag_locked = 1, lei = row["lei"], googleid = "", rssd = row["rssd"], 
                                     cusip = row["cusip"], thrift_hc = row["thrift_hc"], ncua = row["ncua"], fdic_cert = row["fdic_cert"], occ = row["occ"], ein = row["ein"])
        print("completed transfer of CFU")